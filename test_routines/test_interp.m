wname = 'db1';  % wavelets type
tptr  = 'rigrsure'; % thresholding procedure
sorh  = 'h';  % hard or soft threshold option
scal  = 'sln'; % scale procedure
optSPAIDER.wavelets.thr = 0.5;
adap = 1;
is=4; is0=3;
normfrac = 0.4;
tunn=64;
wfact=0.5;
t0=0; tf=10;

% u0=[1 2 3 4.1 4.5 1 1.2 0 3 5 6 3 2 4 8 9 2 3 4 1 2 7 5 3 2 6 3 2 1 9 7 5 4 2 4 6 5 3 ];
% u1=[1 2 3 4.1 4.5 1 1.2 0 3 5 6 3 2 4 8 9 2 3 4 1 2 7 5 3 2 6 3 2 1 9 7 5 4 2 4 6 5 3] + rand(1,length(u0))*3;
% dt=tf/(length(u0));
% ts=0:(dt):tf;

ts0=[0	0.625	1.25	1.875	2.5	3.125	3.75	4.375	5	5.625	6.25	6.875	7.5	8.125	8.75	9.375	10];
u0= [0.002218076	0.003264886	0.004679263	0.006829012	0.009721411	0.013906396	0.020248433	0.028857747	0.049648906	0.072100256	0.097334364	0.13593156	0.191883844	0.328729671	0.925409756	0.918370553	];
ns0=length(u0);

ts1=[0	0.3125	0.625	0.9375	1.25	1.5625	1.875	2.1875	2.5	2.8125	3.125	3.4375	3.75	4.0625	4.375	4.6875	5	5.3125	5.625	5.9375	6.25	6.5625	6.875	7.1875	7.5	7.8125	8.125	8.4375	8.75	9.0625	9.375	9.6875	10];
u1=[0.002023478	0.00248541	0.00302109	0.0036351	0.004349764	0.005165801	0.006150894	0.007349048	0.008919724	0.010791724	0.012926377	0.015368003	0.018425057	0.022021518	0.026967601	0.032633577	0.044660998	0.05365275	0.067096226	0.078265914	0.09013193	0.105367843	0.125520058	0.148239144	0.176919719	0.218710046	0.258047257	0.454057266	0.924775981	0.905223832	0.924794153	0.926000482	];
ns1=length(u1);

ts3=[0	0.078125	0.15625	0.234375	0.3125	0.390625	0.46875	0.546875	0.625	0.703125	0.78125	0.859375	0.9375	1.015625	1.09375	1.171875	1.25	1.328125	1.40625	1.484375	1.5625	1.640625	1.71875	1.796875	1.875	1.953125	2.03125	2.109375	2.1875	2.265625	2.34375	2.421875	2.5	2.578125	2.65625	2.734375	2.8125	2.890625	2.96875	3.046875	3.125	3.203125	3.28125	3.359375	3.4375	3.515625	3.59375	3.671875	3.75	3.828125	3.90625	3.984375	4.0625	4.140625	4.21875	4.296875	4.375	4.453125	4.53125	4.609375	4.6875	4.765625	4.84375	4.921875	5	5.078125	5.15625	5.234375	5.3125	5.390625	5.46875	5.546875	5.625	5.703125	5.78125	5.859375	5.9375	6.015625	6.09375	6.171875	6.25	6.328125	6.40625	6.484375	6.5625	6.640625	6.71875	6.796875	6.875	6.953125	7.03125	7.109375	7.1875	7.265625	7.34375	7.421875	7.5	7.578125	7.65625	7.734375	7.8125	7.890625	7.96875	8.046875	8.125	8.203125	8.28125	8.359375	8.4375	8.515625	8.59375	8.671875	8.75	8.828125	8.90625	8.984375	9.0625	9.140625	9.21875	9.296875	9.375	9.453125	9.53125	9.609375	9.6875	9.765625	9.84375	9.921875	10];
u3=[0.002105878	0.002089389	0.002189882	0.002258925	0.002335205	0.002422154	0.002511853	0.002612366	0.002721842	0.00284145	0.0029721	0.00311816	0.003286512	0.003475585	0.003688926	0.003916805	0.004153102	0.004378448	0.004583808	0.00476513	0.004925302	0.005081508	0.005250155	0.005457613	0.005713655	0.006012711	0.006343279	0.0066749	0.006996875	0.007285623	0.007557616	0.007827646	0.00812785	0.008472248	0.008881782	0.009346466	0.00988468	0.010464087	0.011104124	0.011771652	0.012448274	0.013083324	0.013644705	0.014108211	0.014540527	0.014945019	0.015471732	0.016106192	0.016917749	0.017840786	0.01885275	0.019858502	0.020892093	0.02182631	0.022788639	0.023691785	0.02467879	0.025673702	0.026865284	0.0281478	0.029684343	0.031159333	0.037196198	0.038174828	0.040795749	0.042719671	0.044985294	0.047168188	0.04983558	0.052556946	0.05589299	0.059054315	0.062508949	0.065385473	0.068407256	0.070784857	0.07362891	0.076080985	0.079351967	0.082204273	0.085890971	0.088905276	0.092659196	0.095597454	0.099839434	0.103121819	0.10822973	0.112241797	0.118249315	0.122451952	0.128688368	0.132860288	0.139704419	0.14444428	0.152542377	0.157807061	0.167462142	0.172857315	0.184542541	0.190926707	0.203225031	0.208049565	0.223728926	0.230566987	0.249586977	0.255621305	0.278492562	0.315707383	0.361876076	0.234264107	0.597619801	0.884348548	0.969728548	0.908806016	0.897018036	0.905178913	0.918278888	0.913795125	0.914434755	0.916905549	0.915662146	0.916785438	0.916335263	0.916068366	0.919835939	0.919255259	0.923339598	0.92390485	];
ns3=length(u3);

ic=1;
tspan = linspace(t0,tf,100);
for i=1:length(tspan)
        u_pp0(i) = u_reg1(tspan(i),ts0(ic,:),u0(ic,:),1,ns0(ic));
        u_pp1(i) = u_reg1(tspan(i),ts1(ic,:),u1(ic,:),1,ns1(ic));
        u_pp3(i) = u_reg1(tspan(i),ts3(ic,:),u3(ic,:),1,ns3(ic));
end
[fi,fval] = fminsearch(@(fi)obf(u_pp1,u_pp0,fi),[0.1]);

fest = (((fi+1)^1)*u_pp0);
% plot(fest,'o'); hold on; 
fest=roundn (fest, -3);
festB=unique(fest);
% plot(u_pp1,'g')

% figure(2);

%**********************************
fest2 = (((fi+1)^1)*u0);
[cfd,detais0,maxlev,C,L] = wav_mesh_test(fest2,1,ic,wname); % into wavelets domain
[Cth, thrs1, detais1, difdd, w01, s, threshold] = wav_thresh_test(C,L,maxlev,wname,detais0,fest2,tptr,sorh,adap,scal,ic,is,is0,normfrac,optSPAIDER); % Wavelets thresholding
[Pgrad] = adapt(w01,Cth,L,maxlev,ic,tunn,ts0,adap,normfrac) % prospective points...
% [ts_ref w_ref ns_ref point] = meshref(Pgrad,ns0,ic,ts0,u0,t0,tf,wfact);        
[ts_ref w_ref ns_ref point] = meshref(Pgrad,ns0,ic,ts0,fest2,t0,tf,wfact);      
ts_1(ic,1:ns_ref+1)=ts_ref;
w0ns_1(ic,1:ns_ref)=w_ref;
ns_ref_1=ns_ref;
%**********************************
fest3 = (((fi+1)^1)*w0ns_1);
[cfd,detais0,maxlev,C,L] = wav_mesh_test(fest3,1,ic,wname); % into wavelets domain
[Cth, thrs1, detais1, difdd, w01, s, threshold] = wav_thresh_test(C,L,maxlev,wname,detais0,fest3,tptr,sorh,adap,scal,ic,is,is0,normfrac,optSPAIDER); % Wavelets thresholding
[Pgrad] = adapt(w01,Cth,L,maxlev,ic,tunn,ts_1,adap,normfrac) % prospective points...
[ts_ref w_ref ns_ref point] = meshref(Pgrad,ns_ref_1,ic,ts_1,fest3,t0,tf,wfact);        
ts_2(ic,1:ns_ref+1)=ts_ref;
w0ns_2(ic,1:ns_ref)=w_ref;
ns_ref_2=ns_ref;
nstage=ns0; ui=u0; t_stage=ts0;
for i=1:4
ui_stage(i,1:nstage) = (((fi+1)^1)*ui);
[cfd,detais0,maxlev,C,L] = wav_mesh_test(ui_stage(i,1:nstage),1,ic,wname); % into wavelets domain
[Cth, thrs1, detais1, difdd, w01, s, threshold] = wav_thresh_test(C,L,maxlev,wname,detais0,ui_stage(i,1:nstage),tptr,sorh,adap,scal,ic,is,is0,normfrac,optSPAIDER); % Wavelets thresholding
[Pgrad] = adapt(w01,Cth,L,maxlev,ic,tunn,t_stage,adap,normfrac); % prospective points...
[ts_ref w_ref ns_ref point] = meshref(Pgrad,nstage,ic,t_stage,ui_stage(i,1:nstage),t0,tf,wfact);        
t_stage(ic,1:ns_ref+1)=ts_ref;
ui(1,1:ns_ref)=w_ref;
nstage=ns_ref;

end

x = [ts0];
y = [u0 u0(end)];
xx = unique(t_stage);
yy = spline(x,y,xx);
plot(x,y,'o',xx,yy,'*')


for i=2:length(t_stage)
       uj(i) = u_reg1(0.5*(t_stage(i)+t_stage(i-1)),ts0(ic,:),u0(ic,:),1,ns0(ic));
end

stairs(t_stage,uj,'*'); hold on;
stairs(ts0,[u0 u0(end)],'-');
[fi,fval] = fminsearch(@(fi)obf(yy,ui,fi),[0.1]);

%**********************************
ns(ic)=ns_ref;  
% stairs(ts1,[fest2 fest2(end)],'*'); hold on;
stairs(t_stage,[ui ui(end)],'o'); hold on;
stairs(ts3,[u3 u3(end)],'r'); 
